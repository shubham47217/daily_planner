<script>
  /*******************
   * Persistence
   *******************/
  const LS_KEY = 'dp_tasks_v1';
  const state = {
    tasks: loadTasks(),
    timers: new Map(),
    alarmEnabled: false,
    audioCtx: null
  };

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state.tasks)); updateStats(); }
  function loadTasks(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return []; } }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

  const listEl = document.getElementById('list');

  function fmt(n){ return String(n).padStart(2,'0'); }
  function secToMMSS(sec){ sec=Math.max(0,Math.floor(sec));return ${fmt(Math.floor(sec/60))}:${fmt(sec%60)}; }
  function dayKey(ts){ const d=new Date(ts); return ${d.getFullYear()}-${fmt(d.getMonth()+1)}-${fmt(d.getDate())}; }
  function niceDate(ts){ return new Date(ts).toLocaleString(); }
  function prettyDayHeader(k){ const [y,m,d]=k.split('-'); return ${parseInt(m)}/${parseInt(d)}/${y}; }

  /*******************
   * Rendering
   *******************/
  function render(){
    listEl.innerHTML='';
    const groups={};
    for(const t of state.tasks){ (groups[dayKey(t.createdAt)] ||= []).push(t); }
    const keys=Object.keys(groups).sort((a,b)=>b.localeCompare(a));
    for(const k of keys){
      const wrap=document.createElement('div');wrap.className='day';
      wrap.innerHTML=<h2>${prettyDayHeader(k)}</h2>;
      for(const t of groups[k]) wrap.appendChild(renderCard(t));
      listEl.appendChild(wrap);
    }
    updateStats();
  }

  function renderCard(task){
    const tpl=document.getElementById('taskCardTpl').content.firstElementChild.cloneNode(true);
    tpl.dataset.id=task.id;
    tpl.id='task-'+task.id;
    tpl.querySelector('.tTitle').textContent=task.title||'Untitled task';
    tpl.querySelector('.tMeta').textContent=niceDate(task.createdAt);
    tpl.querySelector('.tLimit').textContent=secToMMSS(task.limitSec);

    const remainEl=tpl.querySelector('.tRemain');
    const elapsedEl=tpl.querySelector('.tElapsed');
    const failPill=tpl.querySelector('.tFail');

    function paint(){
      remainEl.textContent=secToMMSS(Math.max(0,task.limitSec-task.elapsedSec));
      elapsedEl.textContent=secToMMSS(task.elapsedSec);
      failPill.style.display=task.status==='failed'?'inline-flex':'none';
    }
    function setRunningUI(r){ tpl.querySelector('.tStart').textContent=r?'⏸ Pause':'▶ Start'; }
    paint(); setRunningUI(task.running);

    tpl.querySelector('.tStart').onclick=()=>{ task.running?pauseTask(task.id):startTask(task.id); };
    tpl.querySelector('.tReset').onclick=()=>resetTask(task.id);
    tpl.querySelector('.tDone').onclick=()=>completeTask(task.id);
    tpl.querySelector('.tEdit').onclick=()=>editTask(task.id);
    tpl.querySelector('.tDelete').onclick=()=>deleteTask(task.id);

    tpl._paint=paint; tpl._setRun=setRunningUI;

    if(task.running) scheduleTick(task.id);
    return tpl;
  }

  /*******************
   * Task ops
   *******************/
  function addTask({title,durationMin,startAt}){
    const id=uid();
    const t={id,title:title.trim(),createdAt:Date.now(),elapsedSec:0,
             limitSec:Math.max(60,Math.floor(durationMin*60)||1500),
             running:false,status:'pending',startAt:startAt||null};
    state.tasks.unshift(t);
    save();
    render();
  }
  function startTask(id){const t=state.tasks.find(x=>x.id===id);if(!t)return;
    if(t.status==='done')return;t.running=true;t.status='running';t._lastTick=Date.now();scheduleTick(id);save();updateCardView(id);}
  function pauseTask(id){const t=state.tasks.find(x=>x.id===id);if(!t)return;t.running=false;clearInterval(state.timers.get(id));state.timers.delete(id);save();updateCardView(id);}
  function resetTask(id){const t=state.tasks.find(x=>x.id===id);if(!t)return;t.elapsedSec=0;t.status='pending';pauseTask(id);save();updateCardView(id);}
  function completeTask(id){const t=state.tasks.find(x=>x.id===id);if(!t)return;t.status='done';pauseTask(id);save();updateCardView(id);}
  function deleteTask(id){pauseTask(id);state.tasks=state.tasks.filter(x=>x.id!==id);save();render();}
  function editTask(id){const t=state.tasks.find(x=>x.id===id);if(!t)return;
    const title=prompt('Edit title',t.title||'Untitled task');if(title===null)return;
    const mins=parseInt(prompt('Duration (minutes)',Math.round(t.limitSec/60))||'');if(!isNaN(mins)&&mins>0)t.limitSec=mins*60;
    t.title=title.trim();save();updateCardView(id);}

  function scheduleTick(id){clearInterval(state.timers.get(id));
    const t=state.tasks.find(x=>x.id===id);if(!t)return;
    const h=setInterval(()=>{if(!t.running)return;
      const now=Date.now(),dt=Math.floor((now-(t._lastTick||now))/1000);t._lastTick=now;
      if(dt>0){t.elapsedSec+=dt;
        if(t.elapsedSec>=t.limitSec){t.elapsedSec=t.limitSec;t.status='failed';t.running=false;clearInterval(h);state.timers.delete(id);ring();}
        save();updateCardView(id);}
    },1000);state.timers.set(id,h);}

  function updateCardView(id){const t=state.tasks.find(x=>x.id===id);const el=document.getElementById('task-'+id);
    if(t&&el){el.querySelector('.tTitle').textContent=t.title||'Untitled task';
      el.querySelector('.tLimit').textContent=secToMMSS(t.limitSec);
      el._paint&&el.paint();el.setRun&&el._setRun(t.running);}updateStats();}

  /*******************
   * Stats
   *******************/
  function updateStats(){document.getElementById('statTotal').textContent=state.tasks.length;
    document.getElementById('statRunning').textContent=state.tasks.filter(t=>t.running).length;
    document.getElementById('statFailed').textContent=state.tasks.filter(t=>t.status==='failed').length;}

  /*******************
   * Alarm
   *******************/
  function ensureAudio(){if(!state.audioCtx)state.audioCtx=new (window.AudioContext||window.webkitAudioContext)();return state.audioCtx;}
  function ring(){if(!state.alarmEnabled)return;const ctx=ensureAudio(),o=ctx.createOscillator(),g=ctx.createGain();
    o.type='triangle';o.frequency.value=880;g.gain.value=.05;o.connect(g);g.connect(ctx.destination);o.start();setTimeout(()=>o.stop(),800);}

  /*******************
   * UI Wiring
   *******************/
  document.getElementById('addBtn').onclick=()=>{
    const title=document.getElementById('titleInput').value;
    const mins=parseInt(document.getElementById('durationInput').value||'25');
    const startAtStr=document.getElementById('startAtInput').value;
    addTask({title,durationMin:mins,startAt:startAtStr?new Date(startAtStr).toISOString():null});
    document.getElementById('titleInput').value='';
  };

  document.getElementById('clearAll').onclick=()=>{if(!confirm('Clear all?'))return;for(const [id,h]of state.timers)clearInterval(h);
    state.timers.clear();state.tasks=[];save();render();};

  document.getElementById('alarmBtn').onclick=async()=>{try{ensureAudio();await state.audioCtx.resume();}catch(e){}
    state.alarmEnabled=true;document.getElementById('alarmBtn').textContent='🔔 Alarm Ready';};

  // init
  render();
</script>
